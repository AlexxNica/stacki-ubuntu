<?xml version="1.0" standalone="no"?>

<kickstart>

<post interpreter="/opt/stack/bin/python">
import stack.api
import sys
from shutil import copyfile
import os
res = stack.api.Call('list pallet')
found = False

def doit(name,version,boxos,release,arch):

	rootdir = '/export/stack/pallets'
	baseubuntu = "/".join([rootdir, name, version, boxos, arch])
	netinstall = 'install/netboot/ubuntu-installer/amd64'
	initrd = '/'.join([baseubuntu,netinstall,'initrd.gz'])
	vmlinuz = '/'.join([baseubuntu,netinstall,'linux'])
	tftp_initrd = '/'.join(['/tftpboot/pxelinux', 'initrd.%s' % release])
	tftp_vmlinuz = '/'.join(['/tftpboot/pxelinux', 'vmlinuz.%s' % release])
	copyfile(initrd, tftp_initrd)
	copyfile(vmlinuz, tftp_vmlinuz)
	os.chmod(tftp_vmlinuz, 0755)
	httpubuntu = "/install/%s" % '/'.join(baseubuntu.split('/')[3:])

	kern = 'vmlinuz.%s' % release
	ramdisk = 'initrd.%s' % release

	ubuntu_args='install auto=true \
url=http://&Kickstart_PrivateAddress;/install/sbin/preseed.cgi?arch=x86_64\
&amp;np=2&amp;os=ubuntu ksdevice=bootif biosdevname=0 hostname=unassigned \
locale=en_US.UTF-8 keyboard-configuration/layout=us \
live-installer/net-image=http://&Kickstart_PrivateAddress;%s\
/install/filesystem.squashfs ramdisk_size=150000 nousb interface=auto \
netcfg/get_nameservers=&Kickstart_PrivateDNSServers; \
console=tty0 console=ttyS0,115200n8 \
priority=critical net.ifnames=0' % httpubuntu

	stack.api.Call("add bootaction", [ 'action=ubuntu.%s' % release, 
			'kernel=%s' % kern, 'ramdisk=%s' % ramdisk,
			'args=%s' % ubuntu_args])
	stack.api.Call("set attr", ['attr=UbuntuDistroName', 'value=%s' % release])
	stack.api.Call("set attr", ['attr=UbuntuHttpDir', 'value=%s' % httpubuntu])
	stack.api.Call("set attr", ['attr=UbuntuNetImagePath', 
			'value=http://&Kickstart_PrivateAddress;%s/install/filesystem.squashfs' 
			% httpubuntu])
	stack.api.Call("set attr", ['attr=UbuntAptSetupProtocol', 'value=http'])
	stack.api.Call("set attr", ['attr=UbuntuAptSecurityPath', 'value=%s' % httpubuntu])
	stack.api.Call("set attr", ['attr=ubuntu.netcfg', 'value=static'])
	stack.api.Call("set attr", ['attr=ubuntu.serial', 'value=false'])
	stack.api.Call("set attr", ['attr=ubuntu.grub_dev', 'value=/dev/sda'])

boxes = stack.api.Call('list box')
for b in boxes:
	if b['os'] == 'ubuntu':
		for i in res:
			if i['os'] == 'ubuntu' and i['boxes'] == 'ubuntu':
				found = True
				doit(i['name'],i['version'],i['os'], 
					i['release'].lower(),i['arch'])

if found == False:
	msg = '\nUbuntu distribution not found \n' 
	msg += '\nor Ubuntu-Server pallet not enabled.\n'
	sys.exit(msg)

</post>
<post>
systemctl restart httpd
</post>
</kickstart> 

